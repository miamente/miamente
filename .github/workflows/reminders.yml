name: Send Appointment Reminders

on:
  schedule:
    # Run every 5 minutes
    - cron: "*/5 * * * *"
  workflow_dispatch: # Allow manual triggering

jobs:
  send-reminders:
    runs-on: ubuntu-latest
    
    steps:
      - name: Send Reminders
        run: |
          # Get the function URL from environment variables
          FUNCTION_URL="${{ secrets.REMINDERS_FUNCTION_URL }}"
          AUTH_TOKEN="${{ secrets.REMINDERS_AUTH_TOKEN }}"
          
          if [ -z "$FUNCTION_URL" ] || [ -z "$AUTH_TOKEN" ]; then
            echo "Error: Missing required secrets"
            echo "Please set REMINDERS_FUNCTION_URL and REMINDERS_AUTH_TOKEN in repository secrets"
            exit 1
          fi
          
          echo "Sending reminders..."
          
          # Make the request to the Firebase Function
          response=$(curl -s -w "\n%{http_code}" \
            -H "Authorization: Bearer $AUTH_TOKEN" \
            -H "Content-Type: application/json" \
            "$FUNCTION_URL")
          
          # Extract response body and status code
          http_code=$(echo "$response" | tail -n1)
          response_body=$(echo "$response" | head -n -1)
          
          echo "HTTP Status: $http_code"
          echo "Response: $response_body"
          
          # Check if the request was successful
          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ Reminders sent successfully"
            
            # Parse the response to show statistics
            reminders24h=$(echo "$response_body" | jq -r '.reminders24h // 0')
            reminders1h=$(echo "$response_body" | jq -r '.reminders1h // 0')
            postSession=$(echo "$response_body" | jq -r '.postSession // 0')
            
            echo "üìä Statistics:"
            echo "  - 24h reminders: $reminders24h"
            echo "  - 1h reminders: $reminders1h"
            echo "  - Post-session emails: $postSession"
          else
            echo "‚ùå Failed to send reminders"
            echo "Response: $response_body"
            exit 1
          fi
          
        env:
          # These should be set in GitHub repository secrets
          REMINDERS_FUNCTION_URL: ${{ secrets.REMINDERS_FUNCTION_URL }}
          REMINDERS_AUTH_TOKEN: ${{ secrets.REMINDERS_AUTH_TOKEN }}
